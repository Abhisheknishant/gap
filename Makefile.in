#############################################################################
##
#W  Makefile                    GAP source                       Frank Celler
##
#H  @(#)$Id: Makefile.in,v 4.40 2009/10/02 21:57:29 alexk Exp $
##
#Y  Copyright (C)  1997,  Lehrstuhl D fuer Mathematik,  RWTH Aachen,  Germany
##
##  This file is the top level make file.  It is generated from `Makefile.in'
##  by the `configure' script.  After unpacking GAP you simply type
##
##    ./configure
##
##  to create a make file and then
##
##    make
##
##  to compile and link GAP.
##
##  The "default" target:
##    - creates a subdirectory CPU-VENDOR-OS in the directory `bin',
##    - copies the configuration script into this directory,
##    - it switches into this directory and executes the configure script,
##    - it makes GAP in this directory.
##
##  The "clean" target:
##    - removes the subdirectory CPU-VENDOR-OS in the directory `bin'
##    - removes any files created by `configure'
##
##  The "testinstall" target:
##    - starts GAP and reads `tst/testall.g'
##
##  The "teststandard" target:
##    - starts GAP and reads all files `tst/*.tst'
##
##  The "teststandardrenormalize" target:
##    - starts GAP, reads all files `tst/*.tst', and replaces the scaling
##      factors  in the `STOP_TEST' statements
##
##  The "testall.g" target:
##    - creates `tst/testall.g' based on the existing version and the
##      available `tst/*.tst' files
##
##  The "testpackages" target:
##    - runs the tests provided by the available packages
##
##  The "testmanuals" target:
##    - runs the examples in the main GAP documentation
##

SHELL=/bin/sh
CC=@CC@
BASECC=@BASECC@
@SET_MAKE@
GMP_CFLAGS=@GMP_CFLAGS@
GMP_LIBS=@GMP_LIBS@
MAKE_GMP=@MAKE_GMP@

TESTGAP = ./bin/gap.sh -b -m 100m -o 500m -A -N -q -x 80 -r
TESTGAPauto = ./bin/gap.sh -b -m 100m -o 500m -N -q -x 80 -r

default: compile

config: bin/@target@-@BASECC@/configure  bin/@target@-@BASECC@/Makefile bin/@target@-@BASECC@/extern/Makefile 

bin/@target@-@BASECC@/configure: cnf/configure.out 
	if test ! -d bin;  then mkdir bin;  fi
	if test ! -d bin/@target@-@BASECC@;  then mkdir bin/@target@-@BASECC@;  fi
	@rm -f bin/@target@-@BASECC@/configure
	cp cnf/configure.out bin/@target@-@BASECC@/configure


bin/@target@-@BASECC@/Makefile bin/@target@-@BASECC@/extern/Makefile : bin/@target@-@BASECC@/configure cnf/config.hin \
									cnf/gac.in extern/Makefile.in cnf/Makegap.in
	if test ! -d bin/@target@-@BASECC@/extern; then mkdir bin/@target@-@BASECC@/extern; fi
	( cd bin/@target@-@BASECC@ ; CC='$(CC)' ./configure --target=@target@ @gp_configure_options@ )

extern: config
	( cd bin/@target@-@BASECC@/extern ; $(MAKE) CC='$(CC)' '$(MAKE_GMP)' )

compile: extern
	( cd bin/@target@-@BASECC@ ; $(MAKE) CC='$(CC)' GMP_CFLAGS='$(GMP_CFLAGS)' GMP_LIBS='$(GMP_LIBS)' )
	chmod +x bin/gap.sh

static: extern
	( cd bin/@target@-@BASECC@ ; $(MAKE) static CC='$(CC)' )
	chmod +x bin/gap.sh
	( cd bin/@target@-@BASECC@ ; strip gap@EXEEXT@)

strip: compile
	if ! grep darwin sysinfo.gap ; then ( cd bin/@target@-@BASECC@ ; strip gap@EXEEXT@) ; fi

removewin: strip
	( rm -f bin/*.exe bin/*.dll bin/*.bat bin/*.pif "bin/GAP 4 PPC")

rebuild:
	rm -f config.cache config.log config.status
	touch src/*

clean: clean_gmp clean_gap

clean_no_gmp: clean_gap

clean_gap: rebuild
	rm Makefile
	rm -rf bin/@target@-@BASECC@
	rm -f bin/gap.sh

clean_gmp:
	if test -h extern/gmp; then \
	 (cd extern/gmp; make clean); fi
	if test -d extern/lib; then \
	 (cd extern/lib; rm -f libgmp*); fi
	if test -r extern/include; then \
	 (cd extern/include; rm -f gmp.h); fi

manuals:
	( echo 'SaveWorkspace( "doc/wsp.g" );' | $(TESTGAP) )
	( cd doc/ref; echo 'Read( "makedocrel.g" );' | \
          ../../$(TESTGAP) -L ../wsp.g > make_manuals.out )
	( cd doc/tut; echo 'Read( "makedocrel.g" );' | \
          ../../$(TESTGAP) -L ../wsp.g > make_manuals.out )
	( cd doc/ref; echo 'Read( "makedocrel.g" );' | \
          ../../$(TESTGAP) -L ../wsp.g > make_manuals.out )
	( cd doc/tut; echo 'Read( "makedocrel.g" );' | \
          ../../$(TESTGAP) -L ../wsp.g > make_manuals.out )
	( rm doc/wsp.g )


testinstall:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( echo 'ReadGapRoot( "tst/testutil.g" ); \
            ReadGapRoot( "tst/testall.g" );' | $(TESTGAP) > \
            `date -u +dev/log/testinstall1_%Y-%m-%d-%H-%M` )
	( echo 'ReadGapRoot( "tst/testutil.g" ); LoadAllPackages(); \
            ReadGapRoot( "tst/testall.g" );' | $(TESTGAP) > \
            `date -u +dev/log/testinstall2_%Y-%m-%d-%H-%M` )

teststandard:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( echo 'RunStandardTests( [' > test.tmp; \
          grep -h "STOP_TEST" tst/*.tst | \
            sed -e 's/^gap> STOP_TEST(/[/;s/);/],/' >> test.tmp; \
          echo '] ); GAPInfo.SystemInformation( true, true );' >> test.tmp )
	( echo 'ReadGapRoot( "tst/testutil.g" ); \
            Read( "test.tmp" ); Runtime();' | $(TESTGAP) > \
            `date -u +dev/log/teststandard1_%Y-%m-%d-%H-%M` )
	( echo 'ReadGapRoot( "tst/testutil.g" ); LoadAllPackages(); \
            Read( "test.tmp" ); Runtime();' | $(TESTGAP) > \
            `date -u +dev/log/teststandard2_%Y-%m-%d-%H-%M` )
	( rm test.tmp )

teststandardrenormalize:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( echo 'RunStandardTests( [' > test.tmp; \
          grep -h "STOP_TEST" tst/*.tst | \
            sed -e 's/^gap> STOP_TEST(/[/;s/);/],/' >> test.tmp; \
          echo '], true ); GAPInfo.SystemInformation( true, true );' \
          >> test.tmp; \
          echo 'ReadGapRoot( "tst/testutil.g" ); Read( "test.tmp" ); \
            CreateTestallFile(); Runtime();' | $(TESTGAP) > \
            `date -u +dev/log/teststandardrenormalize_%Y-%m-%d-%H-%M` )
	( rm test.tmp )

testall.g:
	( echo 'ReadGapRoot( "tst/testutil.g" ); \
            CreateTestallFile();' | $(TESTGAP) )

testpackages:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( echo 'SetAssertionLevel( 2 ); ReadGapRoot( "tst/testutil.g" ); \
            SaveWorkspace( "wsp.g" );' | $(TESTGAP) )
	( echo -e "CreatePackageTestsInput( \042testpackages.in\042, \
            [ \042`date -u +dev/log/testpackages1_%Y-%m-%d-%H-%M`\042, \
              \042`date -u +dev/log/testpackages2_%Y-%m-%d-%H-%M`\042 ], \
            \042$(TESTGAP) -L wsp.g\042 );"\
            | $(TESTGAP) -L wsp.g > /dev/null )
	( chmod 777 testpackages.in; ./testpackages.in; rm testpackages.in )
	( rm wsp.g )

testpackagesload:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( echo 'ReadGapRoot( "tst/testutil.g" ); \
            SaveWorkspace( "wsp.g" );' | $(TESTGAP) )
	( echo -e "CreatePackageLoadTestsInput( \042testpackagesload.in\042, \
            \042`date -u +dev/log/testpackagesload1_%Y-%m-%d-%H-%M`\042, \
            \042$(TESTGAP) -L wsp.g\042, false );"\
            | $(TESTGAP) -L wsp.g > /dev/null )
	( chmod 777 testpackagesload.in; ./testpackagesload.in; rm testpackagesload.in )
	( rm wsp.g )	
	( echo 'ReadGapRoot( "tst/testutil.g" ); \
            SaveWorkspace( "wsp.g" );' | $(TESTGAPauto) )
	( echo -e "CreatePackageLoadTestsInput( \042testpackagesload.in\042, \
            \042`date -u +dev/log/testpackagesloadA_%Y-%m-%d-%H-%M`\042, \
            \042$(TESTGAPauto) -L wsp.g\042, true );"\
            | $(TESTGAPauto) -L wsp.g > /dev/null )
	( chmod 777 testpackagesload.in; ./testpackagesload.in; rm testpackagesload.in )
	( rm wsp.g )

testmanuals:
	( if ! test -d dev/log; then mkdir -p dev/log; fi )
	( if ! test -d doc/test/tut; then mkdir -p doc/test/tut; fi )
	( if ! test -d doc/test/ref; then mkdir -p doc/test/ref; fi )
	( echo 'LoadPackage( "gapdoc" ); Read( "tst/testutil.g" ); \
 	  ExtractManualExamples( "tut" ); ExtractManualExamples( "ref" );' | $(TESTGAP) )
	( echo 'SetAssertionLevel( 2 ); LoadPackage( "gapdoc" ); \
 	  SaveWorkspace( "doc/test/wsp.g" );' | $(TESTGAP) )
	( cd doc/test/tut; ../mktestx.sh )
	( cd doc/test/ref; ../mktestx.sh )
	(  cd doc/test; \
	  cat tut/diffs ref/diffs \
	  > `date -u +../../dev/log/testmanuals1_%Y-%m-%d-%H-%M` )
	( rm doc/test/tut/diffs; rm doc/test/ref/diffs )
	( echo 'SetAssertionLevel( 2 );  \
 	  SaveWorkspace( "doc/test/wsp.g" );' | $(TESTGAPauto) )
	( cd doc/test/tut; ../mktestx.sh )
	( cd doc/test/ref; ../mktestx.sh )
	(  cd doc/test; \
	  cat tut/diffs ref/diffs \
	  > `date -u +../../dev/log/testmanualsA_%Y-%m-%d-%H-%M` )
	( rm doc/test/tut/diffs; rm doc/test/ref/diffs )
	( echo 'SetAssertionLevel( 2 ); LoadAllPackages(); \
 	  SaveWorkspace( "doc/test/wsp.g" );' | $(TESTGAP) )
	( cd doc/test/tut; ../mktestx.sh )
	( cd doc/test/ref; ../mktestx.sh )
	(  cd doc/test; \
	  cat tut/diffs ref/diffs \
	  > `date -u +../../dev/log/testmanuals2_%Y-%m-%d-%H-%M` )
	( rm doc/test/tut/diffs; rm doc/test/ref/diffs )
	( rm doc/test/tut/*.tst; rm doc/test/ref/*.tst )  
	( rm doc/test/wsp.g )

compilecygwindll:	config
	( cd bin/@target@-@BASECC@ ; $(MAKE) CC='$(CC)' ; \
	  ./gac -o gapw95 -p "-DIOSTATIC -DEDIVSTATIC -DNCURSESSTATIC" \
	        -P "-lpanel -lncurses" ../../pkg/io/src/io.c \
	        ../../pkg/edim/src/ediv.c ../../pkg/Browse/src/ncurses.c ; \
	  strip gapw95.exe ; \
	  cp gapw95.exe .. ; \
	  gcc -c -o gap.o ../../src/gap.c -I. -I../.. -DCONFIG_H \
	      -DCOMPILECYGWINDLL ; \
	  gcc -o gap.dll -shared *.o ; \
	  rm -f gap.o ; \
	  gcc -o gapw95p ../../src/gapw95.c gap.dll ; \
	  strip gapw95p.exe ; \
	  cp gapw95p.exe gap.dll .. ; \
	  cp /bin/cygncurses-8.dll /bin/cygpanel-8.dll /bin/cygwin1.dll \
	     /bin/libW11.dll /usr/bin/rxvt.exe /usr/bin/regtool.exe .. )
	( cd pkg/io ; ./configure ; $(MAKE) CC='$(CC)' )
	( cd pkg/edim ; ./configure ; $(MAKE) CC='$(CC)' )
	( cd pkg/Browse ; ./configure ; $(MAKE) CC='$(CC)' )
	( rm -rf terminfo )
	( mkdir terminfo ; mkdir terminfo/c ; mkdir terminfo/r ; \
	  mkdir terminfo/x )
	( cp /usr/share/terminfo/c/cygwin terminfo/c )
	( cp /usr/share/terminfo/r/rxvt terminfo/r )
	( cp /usr/share/terminfo/x/xterm terminfo/x )

winbinp:
	( tar cfz ../winbin.tgz bin/cyg*dll bin/gap.dll \
	  bin/gapw95.exe \
	  bin/gapw95p.exe bin/@target@-@BASECC@/gac \
	  bin/@target@-@BASECC@/config.h \
	  bin/@target@-@BASECC@/gap.dll \
	  pkg/io/bin/@target@-@BASECC@/io.so \
	  pkg/edim/bin/@target@-@BASECC@/ediv.so \
	  pkg/Browse/bin/@target@-@BASECC@/ncurses.so \
	  terminfo )

