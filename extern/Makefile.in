ifndef BUILD_MODE
 BUILD_MODE=@BUILD_MODE@
endif
CFLAGS=@CFLAGS@ @ABI_CFLAGS@ $(COPTS)
LDFLAGS=@LDFLAGS@ $(LOPTS)
CC=@CC@
MPFRVER=2.3.1

all: jenkins $(MAKE_GMP)

all_gmp_mpfr: jenkins $(MAKE_GMP) mpfr

jenkins: jenkins/jhash.o

jenkins/jhash.o: jenkins/jhash.h ../../../../extern/jenkins/jhash.c
	@( cd ../../../../extern/jenkins; $(MAKE) TARGET='$(TARGET)' BASECC='$(BASECC)' CC='$(CC)' CFLAGS='$(CFLAGS)' LDFLAGS='$(LDFLAGS)' BUILD_MODE='$(BUILD_MODE)' ) 

jenkins/jhash.h: ../../../../extern/jenkins/jhash.h
	@mkdir -p jenkins
	@( cd jenkins; rm -f jhash.h; ln -s ../../../../../extern/jenkins/jhash.h .; )

../../../../extern/gmp-5.0.1: ../../../../extern/gmp-5.0.1-patched.tar.gz
	( cd ../../../../extern; tar zxvf gmp-5.0.1-patched.tar.gz )

gmp_config: ../../../../extern/gmp-$(GMP_VER)
	@mkdir -p gmp-$(GMP_VER)
	@( cd ../../../../extern/gmp-$(GMP_VER); \
	   gmp_conf=no; \
	   if test -r Makefile; then \
	    if ! test -r LASTBUILD.$(TARGET)-$(BASECC)-$(BUILD_MODE); then \
	     make distclean; \
	     gmp_conf=yes; \
	    fi; \
	   else \
	    gmp_conf=yes; \
	   fi; \
	   if test "$$gmp_conf" = "yes"; then \
	    echo ""; \
	    echo "Configuring GMP. Logging to bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/configure_log. Please wait... "; \
	    echo ""; \
	    ./configure --prefix=`pwd`/../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER) ABI=$(BUILD_MODE) \
	     > ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/configure_log 2>&1; \
	    rm -f LASTBUILD*; \
	    touch LASTBUILD.$(TARGET)-$(BASECC)-$(BUILD_MODE); \
	   fi; )

gmp_build: gmp_config
	@( cd ../../../../extern/gmp-$(GMP_VER); \
	   echo "" ;\
	    echo "Building GMP. Logging to bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/make_log. Please wait... "; \
	   echo "" ;\
	    $(MAKE) > ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/make_log 2>&1 ; \
	   if ! test -r ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/MAKE_CHECK_PASSED; then \
	    ( echo "" ;\
	      echo "Checking GMP. Logging to bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/check_log. Please wait... "; \
	      echo "" ; \
	      $(MAKE) check > ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/check_log 2>&1 ; \
	      if ! [ $$? -eq 0 ] ; then \
	       ( echo "" ;\
	         echo "***Error: GMP self-check has failed. See bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/check_log for details.***"; \
	         echo "" ;\
		 exit 1 ); \
	      else \
	       touch ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/MAKE_CHECK_PASSED; \
	      fi; ) \
	   fi )

gmp: gmp_build 
	@( cd ../../../../extern/gmp-$(GMP_VER); \
	    echo ""; \
	    echo "Installing GMP in bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/. Logging to bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/install_log. Please wait... "; \
	    echo ""; \
	    $(MAKE) install > ../../bin/$(TARGET)-$(BASECC)/$(BUILD_MODE)-bit/extern/gmp-$(GMP_VER)/install_log 2>&1 )
	@( rm -f gmp; ln -s gmp-$(GMP_VER) gmp )
