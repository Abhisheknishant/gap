#############################################################################
##
#W Makefile.in                                              Laurent Bartholdi
##
#H   @(#)$Id: Makefile.in,v 1.1 2008/06/14 15:45:40 gap Exp $
##
#Y Copyright (C) 2007, Laurent Bartholdi
##
#############################################################################
##
##  This compiles the module polroots, and creates archives
##
#############################################################################

GAC=@GAC@
GAP=@GAP@
LOCALBIN=bin/@ARCH@
CFLAGS=@CFLAGS@ -Wall @WITH_CXSC@ @CXSC_INCLUDEDIR@
GACFLAGS=@MP_GACFLAGS@ -p -fno-stack-protector -p "@WITH_MPFR@" -p "@WITH_MPFI@" -p "@WITH_MPC@" -p "@WITH_CXSC@"

all: @FLOAT_TARGET@

distribute: symlinks help tarballs zoo

$(LOCALBIN):
	mkdir -p $(LOCALBIN)

$(LOCALBIN)/mp_float.so: @MP_FLOAT_O@
	$(CC) -shared -o $@ @MP_FLOAT_O@ @MP_LIBDIR@ @MP_FLOAT_LIB@

$(LOCALBIN)/cxsc_float.so: @CXSC_FLOAT_O@
	$(CXX) -shared -o $@ @CXSC_FLOAT_O@ @CXSC_LIBDIR@ -lcxsc

$(LOCALBIN)/mp_float.o: src/mp_float.c src/mp_float.h
	$(GAC) -d -c -o $@ src/mp_float.c $(GACFLAGS)

$(LOCALBIN)/cxsc_float.o: src/cxsc_float.C src/cxsc_float.h
	$(CXX) $(CFLAGS) -fPIC -o $@ -c src/cxsc_float.C

$(LOCALBIN)/mpfr.o: src/mpfr.c src/mp_float.h
	$(GAC) -d -c -o $@ src/mpfr.c $(GACFLAGS)

$(LOCALBIN)/mpfi.o: src/mpfi.c src/mp_float.h
	$(GAC) -d -c -o $@ src/mpfi.c $(GACFLAGS)

$(LOCALBIN)/mpc.o: src/mpc.c src/mp_float.h
	$(GAC) -d -c -o $@ src/mpc.c $(GACFLAGS)

$(LOCALBIN)/cpoly.o: src/cpoly.c
	$(CXX) $(CFLAGS) -fPIC -o $@ -c src/cpoly.c

clean:
	rm -rf .version $(LOCALBIN) `find doc -type l`

.version: PackageInfo.g
	grep '^Version :=' $< | awk -F'"' '{print $$2}' > $@

symlinks: .version
	mkdir -p www
	rm -f `find www -type l`
	ln -s ../README www/README.float
	ln -s ../PackageInfo.g www/PackageInfo.g
	ln -s chap0.html www/index.html
	ln -s float-`cat .version`.tar.gz www/float.tar.gz
	ln -s floatdoc-`cat .version`.tar.gz www/floatdoc.tar.gz
	ln -s float-`cat .version`.zoo www/float.zoo
	ln -s floatdoc-`cat .version`.zoo www/floatdoc.zoo
	ln -s ../doc/manual.pdf www/manual.pdf
	(cd doc; for i in *.html; do ln -s ../doc/$$i ../www/$$i; done)
	ln -s ../doc/manual.css www/manual.css

help: doc/chap0.html

doc/chap0.html: doc/float.xml lib/float.g
	echo 'LoadPackage("float"); FLOAT_MAKEDOC();' | $(GAP)

checkblocks:
	grep '<#GAPDoc' lib/*g | awk -F'"' '{print $$2}' | sort > @@-blocks
	grep '<#Include' doc/float.xml | awk -F'"' '{print $$2}' | sort > @@-in
	comm -3 @@-blocks @@-in
	rm @@-blocks @@-in

tarballs: .version help
	tar cfz www/float-`cat .version`.tar.gz --exclude '*~' --exclude sandbox --exclude www --exclude CVS --exclude .version -C .. float
	tar cfz www/floatdoc-`cat .version`.tar.gz --exclude '*~' --exclude CVS -C .. float/doc

zoo: .version help
	rm -f www/float-`cat .version`.zoo
	find . -wholename ./sandbox -prune -o -wholename ./www -prune -o -name '*~' -prune -o -name CVS -prune -o -name .version -prune -o -print | zoo ahI www/float-`cat .version`.zoo
	rm -f www/floatdoc-`cat .version`.zoo
	find doc -name '*~' -prune -o -name CVS -prune -o -print | zoo ahI www/floatdoc-`cat .version`.zoo

#E Makefile . . . . . . . . . . . . . . . . . . . . . . . . . . . ends here
