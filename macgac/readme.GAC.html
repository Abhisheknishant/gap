<HTML>
<HEAD>
   <TITLE>GAC for the Macintosh</TITLE>
   <META NAME="Author" CONTENT="Burkhard H&ouml;fling">
   <META NAME="Description" CONTENT="GAC for the Macintosh">
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFFF">
</P>
<H1>GAC for the Macintosh</H1>

<H2>System requirements</H2>

<P>GAC for the Macintosh requires a Macintosh with GAP 4 installed (and running), including
the GAP source files (in the 'src' folder). Moreover, it requires AppleScript and a scriptable
C-compiler/linker. It comes with a suitable Apple Script for Metrowerks CodeWarrior Pro 2. However,
you should have at least a basic knowledge of AppleScript and the Script Editor; moreover if
you don't use CodeWarrior Pro 2, you should be familiar with your C compiler. </P>

<P>So far, dynamically loadable libraries have only been tested and implemented on a Power
Macintosh. Shared libraries on a 68K Mac require the CFM68K system extension and a special
version of the GAP 4 application (please contact the author, <A
HREF="mailto:Burkhard.Hofling@maths.anu.edu.au">Burkhard H&ouml;fling</A> if you need it)
</P>

<H2>Setting up GAC</H2>

<P>Setting up GAC is fairly easy: download the GAC archive from one of the GAP 4 servers
and decompress it with Stuffit Expander. Put the GAC folder anywhere on your hard disk. </P>

<P>Then make an alias of your GAP application and your GAP folder (i.e., the folder which
contains thel 'lib', 'doc', ... folders that come with GAP). Put them into the 'gac' folder and
rename them 'GAP' and 'gap folder'. Then open the file 'make module (src)' with the Apple
Script Editor, and edit the line</P>

<P><TT>		open file "Macintosh HD:Applications:GAP:GAP4b3:GAC:module.µ"</TT></P>

<P>This line should contain a full Macintosh path name to the file 'module.µ' in the 'gac'
folder. Then select 'Save as Run-only' and save your Apple script as an application named
'make module' in your 'gac' folder. You may want to tick the 'never show startup screen'
option.</P>

<P>If your 'gac' folder is not in the GAP folder, you will also have to adjust the project
source settings in the file 'module.µ' because some 'include' files will be in the GAP 'src'
folder.</P>

<P>If you  use a compiler other than CW Pro 2, you may have to modify this Apple Script - the
Apple script should compile a file 'module.c' in the 'gac' folder and link it as a shared library
'module.shlb' in the folder 'gac'  - note that it will need your GAP application as a shared
library. The module must have 'Init__Module' as its main entry point. </P>

<H2>Using GAC</H2>

<P>GAC can be used to compile GAP code into shared (dynamic) or static libraries.
Static libraries are linked with the compiled GAP source file into a new GAP application.
Dynamic libraries are stored in separate files, which are read while GAP starts up, much
like the ordinary GAP libraries. (Use the -D command line option in GAP to see wheter a
library is loaded dynamically, statically or as GAP library file.) Static libraries become
part of the GAP application itself. </P>

<P>Note that GAP will be used to compile the GAP source
code into C, and then a C compiler will be used to compile the C code into 68K- or PPC
code.</P>

<P>In order to make a shared library, make sure that 'Make static
library' in GAC's file menu is not selected (checked). Then choose 'compile...' from
GAC's file menu or drag the file(s) to be compiled onto the GAC application icon. </P>

<P>If you want to compile GAP code into static libraries, check 'Make static
library' in GAC's file menu, then open the files to be compiled as above, by either
choosing 'Compile...' from the file menu, or by dragging it onto the GAC application.. The
resulting C files will be stored in the same folder as the source file, with '.c' appended to
their file names.  When you quit GAC, it will create a file
'compstat.c' in the GAP 'src' folder which contains a list of all
 library files compiled since GAC was started. If this file already exists, you will be
prompted for another file name. This file is needed to make the newly created '.c' files
accessible from the other GAP source files. Note that if you had compiled GAP files before,
you will have to merge the previous file 'compstat.c'  with the new one by hand, to ensure
that all compiled libraries will be linked to GAP. In order to build a new GAP application
containing all shared libraries, you now have to compile all of GAP's code files, the newly
created '.c' files and 'compstat.c' and link them to a new GAP application. </P>

<P>Whenever you have compiled GAP code, use GAP's -D option to make sure your compiled
library is indeed loaded, not the GAP source code.</P>

<P> Note also that, in order to load shared libraries into GAP, extra space is required for
the static data used by these libraries. The amount of memory reserved for
these libraries can be set with the '-a' option; make sure you have allocated enough with the
-D option. </P>

<H2>Problems</H2>

<P> When trying to compile a lot of GAP files at the same time (such as all GAP library
files), there are problems with static libraries. </P>

<P> For Macintosh applications, the number of global symbols is limited to 2^14, i.e. roughly
16000. When compiling the GAP libraries, the actual number of such symbols is about four
times as large. However, it should be possible to create a multiple fragment application.
The other disadvantage of statically linking GAP libraries into GAP is that any update of a
library requires the whole GAP application to be re-linked (which may take several hours)
and shipped (the size of the application would be around 24 Megabytes). </P>

<P> The CW Pro 2 compiler needs heaps of memory when compiling the GAP soruce if global 
optimisation was turned on, especially when the optimisation level is set very high. 
Increasing the memory allocated to CW Pro does not seem to help (in fact, it seems that 
the compiler tries to allocate temporary memory <I>outside</I> the CW IDE application).

<P> The problems with too many shared libraries have been resolved now. </P>

 <HR>
<ADDRESS>Author: <A HREF="mailto:Burkhard.Hofling@maths.anu.edu.au">Burkhard H&ouml;fling</A><BR>Last modified:
14/05/09 <BR> </ADDRESS>
</BODY>
</HTML>
